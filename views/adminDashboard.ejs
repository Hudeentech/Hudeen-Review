<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <h1>Admin Dashboard</h1>
        <p style="text-align: center; color: var(--text-secondary);">Manage testimonials and generate submission links.</p>
        <hr>

        <div class="admin-links">
            <a href="/admin/dashboard" class="btn-primary">Dashboard</a>
            <a href="/admin/testimonials" class="btn-primary">View All Testimonials</a>
        </div>

        <h2>Overview Statistics</h2>
        <div class="admin-dashboard-stats">
            <div class="stat-card">
                <h4>Total Testimonials</h4>
                <div class="count"><%= totalCount %></div>
            </div>
            <div class="stat-card">
                <h4>Pending for Review</h4>
                <div class="count"><%= pendingCount %></div>
            </div>
            <div class="stat-card">
                <h4>Approved Testimonials</h4>
                <div class="count"><%= approvedCount %></div>
            </div>
            <div class="stat-card">
                <h4>Archived Testimonials</h4>
                <div class="count"><%= deletedCount %></div>
            </div>
        </div>

        <% if (pendingTestimonials.length > 0) { %>
            <div class="notification-section">
                <h3>ðŸ”” Urgent: New Testimonials Awaiting Approval!</h3>
                <p>You have **<%= pendingCount %>** testimonial(s) that need your attention.</p>
                <ul>
                    <% pendingTestimonials.forEach(t => { %>
                        <li><strong><%= t.name %></strong> <%= t.company !== 'N/A' ? 'from ' + t.company : '' %>: "<%= t.message.substring(0, 70) %>..."</li>
                    <% }); %>
                </ul>
                <a href="/admin/testimonials" class="btn-primary" style="background: gold; border-radius: 8px; font-weight: 600; text-transform: uppercase; color: var(--text-dark);">Review Pending Now</a>
            </div>
        <% } else { %>
            <div class="notification-section" style="background-color: rgba(34, 197, 94, 0.08); border-color: white;">
                <p>âœ… All caught up! No new testimonials pending review at the moment.</p>
            </div>
        <% } %>

        <div class="generate-link-section">
            <h2>Generate New Testimonial Link</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Create a unique, one-time link for users to submit testimonials. This link expires after 24 hours.</p>
            <button style="background: gold;" id="generateLinkBtn">Create New Submission Link</button>
            <div id="generatedLinkDisplay" class="generated-link" style="display:none;">
                <span id="linkText"></span>
                <button id="copyLinkBtn" style="background: white;" class="copy-btn">Copy Link</button>
            </div>
        </div>
        <div id="toast" class="toast-message"></div>

    </div>

    <script>
        document.getElementById('generateLinkBtn').addEventListener('click', async () => {
            const generateLinkBtn = document.getElementById('generateLinkBtn');
            const linkDisplay = document.getElementById('generatedLinkDisplay');
            const linkTextSpan = document.getElementById('linkText');
            const copyButton = document.getElementById('copyLinkBtn');

            generateLinkBtn.disabled = true;
            linkTextSpan.textContent = 'Generating link...';
            linkDisplay.style.display = 'flex'; // Show loading state

            try {
                const response = await fetch('/admin/generate-link', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();

                if (response.ok) {
                    linkTextSpan.textContent = result.link;
                    linkDisplay.style.display = 'flex'; // Ensure flex for alignment
                    showToast('Link generated successfully!');
                } else {
                    linkTextSpan.textContent = 'Error: ' + (result.error || 'Failed to generate link.');
                    linkDisplay.className = 'generated-link message error'; // Apply error styling
                    showToast('Failed to generate link.', true);
                }
            } catch (error) {
                console.error('Error:', error);
                linkTextSpan.textContent = 'Network error or server unavailable.';
                linkDisplay.className = 'generated-link message error'; // Apply error styling
                showToast('Network error.', true);
            } finally {
                generateLinkBtn.disabled = false;
            }
        });

        document.getElementById('copyLinkBtn').addEventListener('click', () => {
            const linkText = document.getElementById('linkText').textContent;
            const tempInput = document.createElement('textarea');
            tempInput.value = linkText;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            showToast('Link copied to clipboard!');
        });

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast-message show';
            if (isError) {
                toast.style.backgroundColor = 'var(--accent-red)';
                toast.style.borderColor = 'var(--accent-red)';
            } else {
                toast.style.backgroundColor = 'var(--accent-green)'; /* Green for success */
                toast.style.borderColor = 'var(--accent-green)';
            }
            // Toast background for default is card-background, but messages have special bg.
            // For toast, let's stick to a solid color.
            toast.style.backgroundColor = isError ? 'rgba(239, 68, 68, 0.9)' : 'rgba(34, 197, 94, 0.9)';
            toast.style.color = 'white';
            toast.style.border = 'none';

            setTimeout(() => {
                toast.className = toast.className.replace('show', '');
            }, 3000);
        }
    </script>
</body>
</html>
